<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Credencial Estudiantil</title>
  <script src="https://cdn.jsdelivr.net/npm/qrious/dist/qrious.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <link rel="icon" href="/imagenes/images.jpeg">
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #f8f9fa;
      color: #222;
      margin: 0;
      padding: 20px;
      text-align: center;
    }

    h1 { color: #f59e0b; margin-bottom: 5px; }

    #fechaHoy {
      font-size: 15px;
      color: #666;
      margin-bottom: 25px;
    }

    .container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      margin-top: 5%;
    }

    section {
      background: #fff;
      border-radius: 50px;
      padding: 25px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      width: 420px;
      transition: 0.3s;
    }

    section:hover { box-shadow: 0 4px 18px rgba(0,0,0,0.15); }

    h2 { color: #f59e0b; margin-bottom: 10px; }

    input {
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      width: 80%;
      font-size: 16px;
      margin-bottom: 15px;
    }

    canvas {
      display: block;
      margin: 20px auto;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(245,158,11,0.3);
    }

    #info {
      font-size: 15px;
      color: #333;
      margin-top: 15px;
      padding: 10px;
      background: #f3f4f6;
      border-radius: 8px;
      text-align: left;
    }

    #reader {
      width: 300px;
      height: 300px;
      margin: 15px auto;
      border: 2px solid #f59e0b;
      border-radius: 10px;
      background: #fafafa;
      overflow: hidden;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #reader video,
    #reader canvas {
      width: 100% !important;
      height: 100% !important;
      object-fit: cover !important;
    }

    #resultBox {
      margin-top: 10px;
      font-size: 15px;
      padding: 8px;
      border-radius: 6px;
      background: #f3f4f6;
      color: #333;
      min-height: 40px;
    }

    .buttons {
      margin-top: 20px;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    button {
      background: #f59e0b;
      border: none;
      color: white;
      font-weight: 600;
      padding: 10px 18px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 15px;
      transition: 0.3s;
    }

    button:hover { background: #d97706; }
    #cameraBtn.on { background: #10b981; }
  </style>
</head>
<body>
  <h1>üéì Credencial Estudiantil</h1>
  <div id="fechaHoy">üìÖ Cargando fecha...</div>

  <div class="container">

    <section>
      <h2>üßæ Generar C√≥digo QR</h2>
      <input type="text" id="studentId" placeholder="Ingrese su ID (Ej: S010)" />
      <canvas id="qrCanvas" width="200" height="200"></canvas>
      <div id="info"></div>

      <div class="buttons">
        <button id="startBtn">Generar QR</button>
        <button id="downloadBtn" style="display:none;">‚¨áÔ∏è Descargar QR</button>
      </div>
    </section>

    <section>
      <h2>üì∑ Verificar C√≥digo QR</h2>
      <div id="reader"></div>
      <div id="resultBox">Esperando escaneo...</div>
      <div id="countdown" style="margin-top:8px;font-size:14px;color:#444;"></div>

      <div class="buttons">
        <button id="cameraBtn">üé• Encender c√°mara</button>
      </div>
    </section>
  </div>

<script>
  const hoy = new Date();
  const opciones = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
  document.getElementById("fechaHoy").textContent =
    "üìÖ " + hoy.toLocaleDateString("es-EC", opciones);

  const qr = new QRious({ element: document.getElementById('qrCanvas'), size: 200 });
  const statusEl = document.getElementById('info');
  const apiBase = "http://localhost:3000";
  const apiKey = "clave_demo_123";

  const html5QrCode = new Html5Qrcode("reader");
  const resultBox = document.getElementById("resultBox");
  const cameraBtn = document.getElementById("cameraBtn");
  const countdownEl = document.getElementById("countdown");
  let autoRestarting = false;
  let lastMsgHTML = "";
  let lastMsgBg = "";
  let lastMsgColor = "";
  let autoRestart = false;
  let cameraOn = false;
  let isHandlingScan = false;
  let lastStudent = null;

  function playSound(file) {
    // ‚ö†Ô∏è Si tu carpeta se llama "sound" est√° bien as√≠.
    // Si se llama "sounds", cambia a `sounds/${file}`
    const audio = new Audio(`sound/${file}`);
    audio.volume = 1.0;
    audio.play().catch(err => console.warn("No se pudo reproducir el sonido:", err));
  }

  async function startDynamicQR() {
    const id = document.getElementById("studentId").value.trim();
    if (!id) return alert("Ingrese un ID de estudiante");

    const res = await fetch(apiBase + "/generate", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "x-api-key": apiKey
      },
      body: JSON.stringify({ id })
    });

    const data = await res.json();
    if (!data || data.status !== "ok") {
      statusEl.innerHTML = `<p style="color:red;">‚ö†Ô∏è Error al generar QR</p>`;
      return;
    }

    const qrData = { id: data.payload.id, token: data.payload.token };
    qr.set({ value: JSON.stringify(qrData) });

    lastStudent = data.student;
    statusEl.innerHTML = `
      <strong>Nombre:</strong> ${lastStudent.name}<br>
      <strong>Curso:</strong> ${lastStudent.course}
    `;
    document.getElementById("downloadBtn").style.display = "inline-block";
  }

  document.getElementById("startBtn").addEventListener("click", startDynamicQR);

  document.getElementById("downloadBtn").addEventListener("click", () => {
    if (!lastStudent) return alert("Primero genera un QR.");

    const qrCanvas = document.getElementById("qrCanvas");
    const outCanvas = document.createElement("canvas");
    const ctx = outCanvas.getContext("2d");

    const W = 380;
    const padding = 18;
    const logoSize = 90;
    const qrSize = 170;
    const textAreaHeight = 150;
    const headerHeight = 40;

    outCanvas.width = W;
    outCanvas.height = headerHeight + padding + logoSize + 10 + qrSize + textAreaHeight + padding;

    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0, 0, outCanvas.width, outCanvas.height);

    function roundRect(x, y, w, h, r) {
      ctx.beginPath();
      ctx.moveTo(x + r, y);
      ctx.arcTo(x + w, y, x + w, y + h, r);
      ctx.arcTo(x + w, y + h, x, y + h, r);
      ctx.arcTo(x, y + h, x, y, r);
      ctx.arcTo(x, y, x + w, y, r);
      ctx.closePath();
    }

    ctx.lineWidth = 2;
    ctx.strokeStyle = "#e5e7eb";
    roundRect(6, 6, outCanvas.width - 12, outCanvas.height - 12, 18);
    ctx.stroke();

    ctx.fillStyle = "#f3f4f6";
    roundRect(8, 8, outCanvas.width - 16, headerHeight, 14);
    ctx.fill();

    ctx.fillStyle = "#111827";
    ctx.font = "bold 16px Segoe UI";
    ctx.textAlign = "center";
    ctx.fillText("R.V.R", outCanvas.width / 2, 8 + headerHeight/2 + 6);

    const centerX = outCanvas.width / 2;

    function drawWrappedText(text, x, y, maxWidth, lineHeight) {
      const words = text.split(" ");
      let line = "";
      let lines = [];

      for (let i = 0; i < words.length; i++) {
        const testLine = line + words[i] + " ";
        if (ctx.measureText(testLine).width > maxWidth && i > 0) {
          lines.push(line.trim());
          line = words[i] + " ";
        } else line = testLine;
      }
      lines.push(line.trim());

      lines.slice(0, 2).forEach((l, idx) => ctx.fillText(l, x, y + idx * lineHeight));
    }

    function finalizarDescarga() {
      const qrY = headerHeight + padding + logoSize + 12;

      ctx.drawImage(
        qrCanvas,
        0, 0, qrCanvas.width, qrCanvas.height,
        (outCanvas.width - qrSize) / 2,
        qrY,
        qrSize,
        qrSize
      );

      ctx.fillStyle = "#111827";
      ctx.textAlign = "center";

      let y = qrY + qrSize + 32;

      ctx.font = "bold 18px Segoe UI";
      drawWrappedText(lastStudent.name, centerX, y, outCanvas.width - 50, 22);

      y += 50;
      ctx.font = "17px Segoe UI";
      ctx.fillText(lastStudent.course, centerX, y);

      y += 26;
      ctx.font = "15px Segoe UI";
      ctx.fillStyle = "#374151";
      ctx.fillText(`ID: ${lastStudent.id}`, centerX, y);

      const link = document.createElement("a");
      const safeName = lastStudent.name.replace(/[^\w\s-]/g, "").replace(/\s+/g, "_");
      link.download = `QR_${safeName}_${lastStudent.course.replace(/\s+/g, "_")}.png`;
      link.href = outCanvas.toDataURL("image/png"); // ‚úÖ MIME correcto
      link.click();
    }

    const logo = new Image();
    logo.crossOrigin = "anonymous";
    logo.src = "./imagenes/images.jpeg";

    logo.onload = () => {
      const logoY = headerHeight + padding;
      ctx.drawImage(
        logo,
        (outCanvas.width - logoSize) / 2,
        logoY,
        logoSize,
        logoSize
      );
      finalizarDescarga();
    };

    logo.onerror = () => finalizarDescarga();
  });


// =======================
// üì∑ CAMARA (silenciosa)
// =======================
async function startCameraSilenciosa() {
  await html5QrCode.start(
    { facingMode: "environment" },
    { fps: 30, qrbox: 250 },
    onScanSuccess
  );
  cameraOn = true;
  cameraBtn.textContent = "üî¥ Apagar c√°mara";
}

// =======================
// üé• BOTON CAMARA
// =======================
async function toggleCamera() {
  countdownEl.textContent = "";

  if (cameraOn) {
    try {
      await html5QrCode.stop();
    } catch (e) {
      console.warn("Error apagando c√°mara:", e);
    }
    cameraOn = false;
    cameraBtn.textContent = "üé• Encender c√°mara";
    // üëÄ NO tocamos resultBox aqu√≠
    return;
  }

  try {
    await startCameraSilenciosa();

    // ‚úÖ SOLO cuando el usuario enciende manual
    resultBox.innerHTML = "üì∑ C√°mara encendida. Escanee un QR.";
    resultBox.style.background = "#f3f4f6";
    resultBox.style.color = "#333";

  } catch (err) {
    resultBox.innerHTML = "‚ö†Ô∏è No se pudo acceder a la c√°mara: " + err.message;
  }
}

cameraBtn.addEventListener("click", toggleCamera);

// =======================
// üß† ANTIDUPLICADOS
// =======================
let lastDecoded = "";
let lastScanTime = 0;

// =======================
// ‚úÖ ESCANEO
// =======================
async function onScanSuccess(decodedText) {
  const nowMs = Date.now();

  // üîí evita reentradas
  if (isHandlingScan) return;

  // üõë evita que el mismo QR dispare 2 veces seguidas
  if (decodedText === lastDecoded && (nowMs - lastScanTime) < 2000) {
    return;
  }
  lastDecoded = decodedText;
  lastScanTime = nowMs;

  isHandlingScan = true;

  // üî¥ Apagar c√°mara apenas detecta QR
  if (cameraOn) {
    try {
      await html5QrCode.stop();
      // mini pausa para asegurar stop real
      await new Promise(r => setTimeout(r, 200));
    } catch (e) {
      console.warn("Error al detener la c√°mara:", e);
    }
    cameraOn = false;
    cameraBtn.textContent = "üé• Encender c√°mara";
  }

  try {
    const data = JSON.parse(decodedText);

    if (!data.token) {
      resultBox.innerHTML = "‚ùå QR inv√°lido (sin token)";
      resultBox.style.background = "#fee2e2";
      resultBox.style.color = "#991b1b";
      playSound("error.mp3");
    } else {
      const token = data.token;
      const res = await fetch(`${apiBase}/verify?token=${token}`);
      const result = await res.json();

      const hora = new Date().toLocaleTimeString("es-EC", {
        hour: "2-digit", minute: "2-digit", second: "2-digit",
        hour12: true, timeZone: "America/Guayaquil"
      });

      const s = result.student;

      if (result.status === "valid" && result.action === "entrada") {
        resultBox.innerHTML = `
          ‚úÖ <b>Entrada registrada</b><br>
          ${s.name} - ${s.course}<br>
          <small>${hora}</small>`;
        resultBox.style.background = "#d1fae5";
        resultBox.style.color = "#065f46";
        playSound("beep-ok.mp3");
      }
      else if (result.status === "valid" && result.action === "salida") {
        resultBox.innerHTML = `
          üëã <b>Salida registrada</b><br>
          ${s.name} - ${s.course}<br>
          <small>${hora}</small>`;
        resultBox.style.background = "#fef3c7";
        resultBox.style.color = "#92400e";
        playSound("ding-exit.mp3");
      }
      else if (result.status === "disabled_time") {
        resultBox.innerHTML = `
          ‚è∞ <b>QR deshabilitado por horario</b><br>
          Solo se puede registrar hasta las 14:00.<br>
          <small>${hora}</small>`;
        resultBox.style.background = "#e5e7eb";
        resultBox.style.color = "#111827";
        playSound("error.mp3");
      }
      else if (result.status === "limit_reached" || result.status === "revoked") {
        resultBox.innerHTML = `
          üö´ <b>QR deshabilitado</b><br>
          Ya se us√≥ dos veces hoy.<br>
          <small>${hora}</small>`;
        resultBox.style.background = "#fee2e2";
        resultBox.style.color = "#991b1b";
        playSound("error.mp3");
      }
      else if (result.status === "not_found") {
        resultBox.innerHTML = `
          ‚ùì <b>QR no registrado</b><br>
          Verifique que la credencial sea v√°lida.<br>
          <small>${hora}</small>`;
        resultBox.style.background = "#f3f4f6";
        resultBox.style.color = "#333";
        playSound("error.mp3");
      }
      else {
        resultBox.innerHTML = "‚ùå C√≥digo no v√°lido o error de lectura";
        resultBox.style.background = "#f3f4f6";
        resultBox.style.color = "#333";
        playSound("error.mp3");
      }
    }

  } catch (err) {
    console.error(err);
    resultBox.innerHTML = "‚ö†Ô∏è Error al procesar el QR";
    resultBox.style.background = "#f3f4f6";
    resultBox.style.color = "#333";
    playSound("error.mp3");
  }

  // ‚è≥ contador y auto encendido SIN borrar mensajes
  let t = 4;
  countdownEl.textContent = `‚è≥ C√°mara lista en: ${t}s`;

  const timer = setInterval(async () => {
    t--;
    countdownEl.textContent = `‚è≥ C√°mara lista en: ${t}s`;

    if (t <= 0) {
      clearInterval(timer);
      countdownEl.textContent = "";

      try {
        await startCameraSilenciosa();
      } catch (e) {
        console.error("Error al reactivar la c√°mara:", e);
      }

      isHandlingScan = false;
    }
  }, 1000);
}


</script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel de Asistencia - AdministraciÃ³n</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="icon" href="/imagenes/images.jpeg">
  <style>
    body {
      background: #fefefe;
      color: #222;
      font-family: "Poppins", sans-serif;
    }
    .btn-whatsapp {
      background-color: #25D366;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      font-weight: 600;
      transition: 0.3s;
    }
    .btn-whatsapp:hover {
      background-color: #1ebe57;
    }
  </style>
</head>
<body class="p-6">

  <h1 class="text-3xl font-bold mb-6 text-center">ğŸ“‹ Panel de Asistencia</h1>

  <div class="flex justify-center gap-4 mb-6">
    <select id="courseSelect" class="border rounded px-3 py-2">
      <option value="">Selecciona un curso</option>
      <option value="A - InformÃ¡tica">A - InformÃ¡tica</option>
      <option value="B - InformÃ¡tica">B - InformÃ¡tica</option>
    </select>
    <button id="loadBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Cargar Asistencias</button>
    <button id="downloadBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
     â¬‡ï¸ Descargar Asistencia
    </button>

  </div>

  <div id="stats" class="text-center mb-6 hidden">
    <p><strong>âœ… Asistidos:</strong> <span id="countAsistidos">0</span></p>
    <p><strong>âš ï¸ Atrasos:</strong> <span id="countAtrasos">0</span></p>
    <p><strong>âŒ No Asistieron:</strong> <span id="countNoAsistidos">0</span></p>
    <button id="whatsappLink" type="button" class="btn-whatsapp">
     ğŸ“² Enviar Reporte al Tutor
    </button>

  </div>

  <h2 id="titleAsistencias" class="text-xl font-semibold mb-2 hidden">ğŸ§¾ Asistencias de Hoy</h2>
  <table class="w-full border-collapse border border-gray-300 hidden mb-6" id="tableAttendance">
    <thead class="bg-gray-200">
      <tr>
        <th class="border p-2">ID</th>
        <th class="border p-2">Nombre</th>
        <th class="border p-2">Curso</th>
        <th class="border p-2">Tutor</th>
        <th class="border p-2">Estado</th>
        <th class="border p-2">Fecha</th>
      </tr>
    </thead>
    <tbody id="attendanceBody"></tbody>
  </table>

  <h2 id="titleNoAsistidos" class="text-xl font-semibold mb-2 hidden">ğŸš« No Asistieron Hoy</h2>
  <table class="w-full border-collapse border border-gray-300 hidden" id="tableAbsent">
    <thead class="bg-gray-200">
      <tr>
        <th class="border p-2">ID</th>
        <th class="border p-2">Nombre</th>
        <th class="border p-2">Curso</th>
      </tr>
    </thead>
    <tbody id="absentBody"></tbody>
  </table>

<script>
  const loadBtn = document.getElementById('loadBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const tableAttendance = document.getElementById('tableAttendance');
  const tableAbsent = document.getElementById('tableAbsent');
  const attendanceBody = document.getElementById('attendanceBody');
  const absentBody = document.getElementById('absentBody');
  const stats = document.getElementById('stats');
  const whatsappLink = document.getElementById('whatsappLink');
  const courseSelect = document.getElementById('courseSelect');

  const apiBase = "https://proyecto-qr-din-mico.onrender.com";  
  let cursoActual = "";

  // =========================
  // DESCARGAR CSV
  // =========================
  async function downloadCSV() {
    const course = courseSelect.value;
    if (!course) return alert("Selecciona un curso primero");

    cursoActual = course;
    const today = new Date().toISOString().split("T")[0];

    const studentsRes = await fetch(`${apiBase}/students?course=${encodeURIComponent(course)}`);
    const studentsAll = await studentsRes.json();

    const attendRes = await fetch(`${apiBase}/attendance?course=${encodeURIComponent(course)}`);
    const attendances = await attendRes.json();

    const mapToday = {};
    attendances.forEach(a => {
      if (a.date === today) mapToday[String(a.student_id)] = a;
    });

    let csv = "ID,Nombre,Curso,Tutor,Estado,Fecha\n";

    studentsAll.forEach(s => {
      const record = mapToday[String(s.id)];
      if (record) {
        csv += `${s.id},"${s.name}","${s.course}",${record.tutor},${record.status},${record.date}\n`;
      } else {
        csv += `${s.id},"${s.name}","${s.course}",,no asistiÃ³,${today}\n`;
      }
    });

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const dlLink = document.createElement("a");
    dlLink.href = URL.createObjectURL(blob);
    dlLink.download = `asistencia_${course.replace(/\s+/g, "_")}_${today}.csv`;
    dlLink.click();
  }

  // =========================
  // CARGAR ASISTENCIA
  // =========================
  async function loadAttendance() {
    const course = courseSelect.value;
    if (!course) return alert("Selecciona un curso primero");

    cursoActual = course;
    const today = new Date().toISOString().split('T')[0];

    const res = await fetch(`${apiBase}/attendance?course=${encodeURIComponent(course)}`);
    const data = await res.json();

    attendanceBody.innerHTML = "";
    absentBody.innerHTML = "";

    const hoy = data.filter(r => r.date === today);

    let asistidos = 0;
    let atrasos = 0;
    const atrasadosNombres = [];
    const noAsistidosNombres = [];

    // Tabla asistencias de hoy
    hoy.forEach(r => {
      if (r.status === "asistido") asistidos++;
      else if (r.status === "atraso") {
        atrasos++;
        atrasadosNombres.push(r.name);
      }

      attendanceBody.insertAdjacentHTML('beforeend', `
        <tr>
          <td class="border p-2">${r.student_id}</td>
          <td class="border p-2">${r.name}</td>
          <td class="border p-2">${r.course}</td>
          <td class="border p-2">${r.tutor}</td>
          <td class="border p-2">${r.status}</td>
          <td class="border p-2">${r.date}</td>
        </tr>
      `);
    });

    // Obtener lista total de estudiantes del curso
    const resStudents = await fetch(`${apiBase}/students?course=${encodeURIComponent(course)}`);
    const studentsAll = await resStudents.json();

    const asistidosIds = new Set(hoy.map(r => String(r.student_id)));
    const ausentes = studentsAll.filter(s => !asistidosIds.has(String(s.id)));

    ausentes.forEach(a => {
      noAsistidosNombres.push(a.name);
      absentBody.insertAdjacentHTML('beforeend', `
        <tr>
          <td class="border p-2">${a.id}</td>
          <td class="border p-2">${a.name}</td>
          <td class="border p-2">${a.course}</td>
        </tr>
      `);
    });

    const noAsistidos = ausentes.length;

    // Stats
    document.getElementById('countAsistidos').textContent = asistidos;
    document.getElementById('countAtrasos').textContent = atrasos;
    document.getElementById('countNoAsistidos').textContent = noAsistidos;

    stats.classList.remove('hidden');
    tableAttendance.classList.remove('hidden');
    tableAbsent.classList.remove('hidden');
    document.getElementById('titleAsistencias').classList.remove('hidden');
    document.getElementById('titleNoAsistidos').classList.remove('hidden');

    // Mensaje WhatsApp
    const tutor = hoy.length ? hoy[0].tutor : "Tutor no encontrado";
    const phone = hoy.length ? hoy[0].phone : null;
    const fecha = new Date().toLocaleDateString('es-EC');

    let mensaje =
      `Hola ${tutor}, aquÃ­ estÃ¡ el reporte de asistencia del curso ${course} (${fecha}):%0A%0A` +
      `âœ… Asistieron: ${asistidos}%0A` +
      `âš ï¸ Atrasos: ${atrasos}%0A` +
      `âŒ No asistieron: ${noAsistidos}%0A`;

    if (atrasadosNombres.length) {
      mensaje += `%0Aâš ï¸ *Atrasados:*%0A- ${atrasadosNombres.join('%0A- ')}`;
    }
    if (noAsistidosNombres.length) {
      mensaje += `%0A%0AâŒ *No asistieron:*%0A- ${noAsistidosNombres.join('%0A- ')}`;
    }
    mensaje += `%0A%0A_Enviado automÃ¡ticamente por el sistema de asistencia._`;

    if (phone) {
      const numero = String(phone).replace(/\D/g, "");
      const url = `https://wa.me/${numero}?text=${mensaje}`;

      whatsappLink.dataset.url = url;
      whatsappLink.style.pointerEvents = "auto";
      whatsappLink.style.opacity = "1";
    } else {
      whatsappLink.dataset.url = "";
      whatsappLink.style.pointerEvents = "none";
      whatsappLink.style.opacity = "0.6";
      console.warn("âš ï¸ Este curso no tiene telÃ©fono asignado");
    }
  }

  // =========================
  // LISTENERS Y AUTO-REFRESH (SOLO UNA VEZ)
  // =========================
  loadBtn.addEventListener('click', loadAttendance);
  downloadBtn.addEventListener('click', downloadCSV);

  whatsappLink.addEventListener("click", () => {
    const url = whatsappLink.dataset.url;
    if (url) window.open(url, "_blank");
  });

  setInterval(() => {
    if (cursoActual) loadAttendance();
  }, 90000);
</script>


</body>
</html>
